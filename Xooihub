(() => {
  if (window.__OCQUE_POPUP_UI__) return console.log("âš ï¸ UI Ä‘Ã£ tá»“n táº¡i.");

  window.__OCQUE_POPUP_UI__ = { enabled: true };

  const STATE = {
    blockOpen: true,
    blockAssign: true,
    blockReplace: true,
    blockTargetBlank: true,
    logs: true,
  };

  const ORI = {
    open: window.open,
    assign: location.assign.bind(location),
    replace: location.replace.bind(location),
  };

  function log(...args) {
    if (STATE.logs) console.log(...args);
  }

  function enableBlocker() {
    window.open = function (url, name, specs) {
      log("ðŸš« Blocked window.open:", url);
      return null;
    };

    location.assign = function (url) {
      log("ðŸš« Blocked location.assign:", url);
    };

    location.replace = function (url) {
      log("ðŸš« Blocked location.replace:", url);
    };

    // cháº·n target=_blank
    document.addEventListener(
      "click",
      (e) => {
        if (!STATE.blockTargetBlank) return;

        const a = e.target.closest("a");
        if (a && a.target === "_blank") {
          e.preventDefault();
          log("ðŸš« Blocked <a target=_blank>:", a.href);
        }
      },
      true
    );

    log("ðŸŸ¢ Popup Blocker ON");
  }

  function disableBlocker() {
    window.open = ORI.open;
    location.assign = ORI.assign;
    location.replace = ORI.replace;
    log("ðŸ”´ Popup Blocker OFF");
  }

  // ============ UI ============
  const style = document.createElement("style");
  style.textContent = `
  #ocque-ui {
    position: fixed;
    top: 80px;
    left: 40px;
    width: 720px;
    height: 420px;
    background: rgba(18,18,22,0.97);
    border: 2px solid rgba(0,255,255,0.3);
    border-radius: 16px;
    z-index: 999999999;
    font-family: Arial, sans-serif;
    color: white;
    box-shadow: 0 0 25px rgba(0,0,0,0.6);
    overflow: hidden;
  }

  #ocque-topbar {
    height: 45px;
    background: rgba(12,12,15,0.95);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    cursor: move;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }

  #ocque-title {
    font-size: 16px;
    font-weight: bold;
    letter-spacing: 0.5px;
  }

  #ocque-btns {
    display: flex;
    gap: 8px;
  }

  .ocque-btn {
    width: 34px;
    height: 28px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    color: white;
  }

  #ocque-min { background: rgba(255,255,255,0.1); }
  #ocque-close { background: rgba(255,0,0,0.55); }

  #ocque-body {
    display: flex;
    height: calc(100% - 45px);
  }

  #ocque-tabs {
    width: 200px;
    background: rgba(14,14,18,0.95);
    padding: 10px;
    border-right: 1px solid rgba(255,255,255,0.08);
  }

  .ocque-tab {
    padding: 12px;
    border-radius: 12px;
    cursor: pointer;
    margin-bottom: 8px;
    font-size: 14px;
    background: rgba(255,255,255,0.05);
    transition: 0.2s;
  }

  .ocque-tab:hover {
    background: rgba(0,255,255,0.15);
  }

  .ocque-tab.active {
    background: rgba(0,255,255,0.25);
    border: 1px solid rgba(0,255,255,0.25);
  }

  #ocque-content {
    flex: 1;
    padding: 18px;
    position: relative;
  }

  #ocque-avatar {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 85px;
    height: 85px;
    border-radius: 16px;
    border: 2px solid rgba(0,255,255,0.25);
    background-size: cover;
    background-position: center;
    opacity: 0.9;
  }

  .ocque-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .ocque-card h3 {
    margin: 0;
    font-size: 15px;
  }

  .ocque-card p {
    margin: 4px 0 0;
    font-size: 12px;
    opacity: 0.75;
  }

  .ocque-switch {
    width: 52px;
    height: 28px;
    border-radius: 999px;
    background: rgba(255,255,255,0.15);
    position: relative;
    cursor: pointer;
    transition: 0.2s;
  }

  .ocque-switch.on {
    background: rgba(0,255,255,0.35);
  }

  .ocque-dot {
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 3px;
    left: 4px;
    transition: 0.2s;
  }

  .ocque-switch.on .ocque-dot {
    left: 26px;
  }

  #ocque-footer {
    margin-top: 12px;
    font-size: 12px;
    opacity: 0.6;
  }
  `;
  document.head.appendChild(style);

  const ui = document.createElement("div");
  ui.id = "ocque-ui";
  ui.innerHTML = `
    <div id="ocque-topbar">
      <div id="ocque-title">W-Azure Style Popup Blocker | OcQue</div>
      <div id="ocque-btns">
        <button class="ocque-btn" id="ocque-min">-</button>
        <button class="ocque-btn" id="ocque-close">X</button>
      </div>
    </div>

    <div id="ocque-body">
      <div id="ocque-tabs">
        <div class="ocque-tab active" data-tab="main">Main Farm</div>
        <div class="ocque-tab" data-tab="status">Status</div>
        <div class="ocque-tab" data-tab="logs">Logs</div>
      </div>

      <div id="ocque-content">
        <div id="ocque-avatar"></div>

        <div id="tab-main">
          <div class="ocque-card">
            <div>
              <h3>Block window.open</h3>
              <p>Cháº·n popup / tab má»›i báº±ng window.open()</p>
            </div>
            <div class="ocque-switch on" data-key="blockOpen"><div class="ocque-dot"></div></div>
          </div>

          <div class="ocque-card">
            <div>
              <h3>Block location.assign</h3>
              <p>Cháº·n tá»± redirect kiá»ƒu assign()</p>
            </div>
            <div class="ocque-switch on" data-key="blockAssign"><div class="ocque-dot"></div></div>
          </div>

          <div class="ocque-card">
            <div>
              <h3>Block location.replace</h3>
              <p>Cháº·n thay trang kiá»ƒu replace()</p>
            </div>
            <div class="ocque-switch on" data-key="blockReplace"><div class="ocque-dot"></div></div>
          </div>

          <div class="ocque-card">
            <div>
              <h3>Block target="_blank"</h3>
              <p>Cháº·n link má»Ÿ tab má»›i qua target blank</p>
            </div>
            <div class="ocque-switch on" data-key="blockTargetBlank"><div class="ocque-dot"></div></div>
          </div>
        </div>

        <div id="tab-status" style="display:none;">
          <div class="ocque-card">
            <div>
              <h3>Popup Blocker Status</h3>
              <p id="status-text">ðŸŸ¢ Running</p>
            </div>
          </div>
        </div>

        <div id="tab-logs" style="display:none;">
          <div class="ocque-card">
            <div>
              <h3>Console Logs</h3>
              <p>Báº­t táº¯t log spam console</p>
            </div>
            <div class="ocque-switch on" data-key="logs"><div class="ocque-dot"></div></div>
          </div>

          <div id="ocque-footer">Made by OcQue. Humans váº«n thÃ­ch popup, Ä‘Ãºng lÃ  ká»³ láº¡.</div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(ui);

  // Avatar (áº£nh hÃ¬nh 2)
  // M láº¥y link áº£nh Hu Tao chibi online hoáº·c upload github rá»“i dÃ¡n vÃ o Ä‘Ã¢y
  const avatarURL =
    "https://i.imgur.com/6QZ6XkY.png"; // thay link áº£nh hÃ¬nh 2 vÃ o Ä‘Ã¢y
  document.getElementById("ocque-avatar").style.backgroundImage = `url(${avatarURL})`;

  // Tabs switch
  document.querySelectorAll(".ocque-tab").forEach((tab) => {
    tab.onclick = () => {
      document.querySelectorAll(".ocque-tab").forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");

      document.querySelectorAll("#ocque-content > div[id^='tab-']").forEach((c) => {
        c.style.display = "none";
      });

      document.getElementById("tab-" + tab.dataset.tab).style.display = "block";
    };
  });

  // Switch toggle
  document.querySelectorAll(".ocque-switch").forEach((sw) => {
    sw.onclick = () => {
      const key = sw.dataset.key;
      STATE[key] = !STATE[key];

      sw.classList.toggle("on", STATE[key]);

      if (key === "blockOpen" || key === "blockAssign" || key === "blockReplace") {
        if (STATE.blockOpen || STATE.blockAssign || STATE.blockReplace) enableBlocker();
        else disableBlocker();
      }

      log("âš™ï¸ Toggle:", key, "=", STATE[key]);
    };
  });

  // Close
  document.getElementById("ocque-close").onclick = () => {
    disableBlocker();
    ui.remove();
    style.remove();
    delete window.__OCQUE_POPUP_UI__;
    console.log("âŒ UI Removed.");
  };

  // Minimize
  let minimized = false;
  document.getElementById("ocque-min").onclick = () => {
    minimized = !minimized;
    document.getElementById("ocque-body").style.display = minimized ? "none" : "flex";
    ui.style.height = minimized ? "45px" : "420px";
  };

  // Drag move
  const topbar = document.getElementById("ocque-topbar");
  topbar.addEventListener("mousedown", (e) => {
    dragging = true;
    dragStart = { x: e.clientX, y: e.clientY };
    startPos = { x: ui.offsetLeft, y: ui.offsetTop };
  });

  document.addEventListener("mousemove", (e) => {
    if (!dragging) return;
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    ui.style.left = startPos.x + dx + "px";
    ui.style.top = startPos.y + dy + "px";
  });

  document.addEventListener("mouseup", () => (dragging = false));

  // Activate
  enableBlocker();

  console.log("âœ… OcQue Popup UI Loaded.");
})();
